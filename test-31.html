<!DOCTYPE html>
<html>

<head>
  <title>canvas test-31 - 高级loading动画</title>
  <style type="text/css">
  * {
    margin: 0;
    padding: 0
  }
  
  pre {
    padding: 10px 0
  }
  </style>
</head>

<body>
  <pre></pre>
  <p></p>
  <canvas id="stage" width="400" height="400" style="border: 1px solid red; margin: 20px"></canvas>
  <script src="raf.js"></script>
  <script src="vector2.js"></script>
  <script src="resource.js"></script>
  <script type="text/javascript">
  var canvas = document.getElementById('stage');
  var ctx = canvas.getContext('2d');

  var canvasWidth = canvas.width;
  var canvasHeight = canvas.height;
  var centerX = canvasWidth / 2;
  var centerY = canvasHeight / 2;
  var bbox = canvas.getBoundingClientRect();
  var ARC = Math.PI / 180;
  var ARC1 = ARC * 90;
  var ARC2 = ARC * 180;
  var ARC3 = ARC * 270;
  var ARC4 = ARC * 360;
  var DEG = 180 / Math.PI;
  var radius = 100;
  var tick;

  // 点
  var spot = {
    angle: 0,
    radius: 5,
    speed: 4
  };
  var arcperiod = Math.round(Math.sqrt(360) + 19 / 2);
  // 弧
  var arc = {
    angle: 0,
    size: 30,
    radius: radius,
    angleSpeed: spot.speed,
    angleAcceler: spot.speed / 10,
    sizeSpeed: 330 / arcperiod / 2,
    round: 0
  };

  window.onload = function() {
    rendering();
    tick = window.requestAnimationFrame(redraw);
  };

  function redraw() {
    ctx.clearRect(0, 0, canvasWidth + 1, canvasHeight + 1);
    updating();
    rendering();
    window.requestAnimationFrame(redraw);
  }

  function updating() {
    var aa = arc.angle;
    var dir = aa >= 0 && aa < 180 ? 1 : -1; // 0 ~ 180 加速 180 ~ 360 减速
    var av = arc.angleSpeed + dir * arc.angleAcceler;
    var nss = spot.angle + spot.speed;
    var nsa = aa + av;
    if (nsa >= 360) {
      arc.round += 1;
      if (arc.round % 2 === 0) {
        arc.size = 0;
      }
      console.log([arc.size, arc.angle, arc.round]);
      // debugger;
    }
    spot.angle = nss > 360 ? nss - 360 : nss;
    arc.angle = nsa > 360 ? nsa - 360 : nsa;
    arc.size += arc.sizeSpeed;
  }

  function rendering() {
    drawBackground();
    drawArc();
    drawSpot();
  }

  function drawBackground() {
    var size = 56;
    var text = 'LOGO';
    ctx.save();
    ctx.strokeStyle = 'red';
    ctx.fillStyle = 'red';
    ctx.lineWidth = 10;
    ctx.font = 'bold ' + size + 'px Arial';
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, ARC4);
    ctx.closePath();
    ctx.stroke();
    var offset = ctx.measureText(text).width / 2;
    ctx.fillText(text, centerX - offset, centerY + size * .4);
    ctx.restore();
  }

  function drawArc() {
    var arcStart = (arc.angle - 90) * ARC;
    var arcEnd = (arc.angle + arc.size - 90) * ARC;
    ctx.save();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 10;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, arcStart, arcEnd);
    ctx.stroke();
    ctx.restore();
  }

  function drawSpot() {
    var a = (spot.angle - 90) * ARC;
    var ax = centerX + radius * Math.cos(a);
    var ay = centerY + radius * Math.sin(a);
    ctx.save();
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(ax, ay, spot.radius, 0, ARC4);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  </script>
</body>

</html>
