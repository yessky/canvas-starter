<!DOCTYPE html>
<html>

<head>
  <title>canvas test-31 - 高级loading动画</title>
  <style type="text/css">
  * {
    margin: 0;
    padding: 0
  }
  
  pre {
    padding: 10px 0
  }
  </style>
</head>

<body>
  <pre></pre>
  <p></p>
  <canvas id="stage" width="400" height="400" style="border: 1px solid red; margin: 20px"></canvas>
  <script src="raf.js"></script>
  <script src="vector2.js"></script>
  <script src="resource.js"></script>
  <script type="text/javascript">
  var canvas = document.getElementById('stage');
  var ctx = canvas.getContext('2d');

  var canvasWidth = canvas.width;
  var canvasHeight = canvas.height;
  var centerX = canvasWidth / 2;
  var centerY = canvasHeight / 2;
  var bbox = canvas.getBoundingClientRect();
  var ARC = Math.PI / 180;
  var ARC1 = ARC * 90;
  var ARC2 = ARC * 180;
  var ARC3 = ARC * 270;
  var ARC4 = ARC * 360;
  var DEG = 180 / Math.PI;
  var radius = 100;
  var startTime, tickId;

  // 点
  var spot = {
    angle: 0,
    radius: 6,
    angleSwing: 360
  };
  var arcperiod = Math.round(Math.sqrt(360) + 19 / 2);
  // 弧
  var arc = {
    angle: 0,
    size: 30,
    radius: radius,
    angleSwing: 360,
    sizeSwing: 330,
    round: 0
  };

  window.onload = function() {
    rendering();
    startTime = Date.now();
    tickId = window.requestAnimationFrame(redraw);
  };

  function redraw() {
  	ctx.clearRect(0, 0, canvasWidth + 1, canvasHeight + 1);
    updating();
    rendering();
    window.requestAnimationFrame(redraw);
  }

  function updating() {
  	var now = Date.now();
  	var elasped = now - startTime;
  	var percent = elasped / 1500;
    if (percent >= 1) {
    	arc.round += 1;
    	if (arc.round % 2 === 0) {
    		startTime = Date.now();
    		spot.angle = 0;
        arc.size = 30;
      }
    }
    var aa = arc.angle;
    var nspot = spot.angleSwing * percent;
    var nangle = arc.angleSwing * easing(percent);
    var nsize = arc.sizeSwing * percent;
    spot.angle = nspot;
    arc.angle = nangle;
    arc.size = nsize;
  }

  function rendering() {
    drawBackground();
    drawArc();
    drawSpot();
  }

  function drawBackground() {
    var size = 56;
    var text = 'LOGO';
    ctx.save();
    ctx.strokeStyle = 'red';
    ctx.fillStyle = 'red';
    ctx.lineWidth = 10;
    ctx.font = 'bold ' + size + 'px Arial';
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, ARC4);
    ctx.closePath();
    ctx.stroke();
    var offset = ctx.measureText(text).width / 2;
    ctx.fillText(text, centerX - offset, centerY + size * .4);
    ctx.restore();
  }

  function drawArc() {
    var arcStart = (arc.angle - 90) * ARC;
    var arcEnd = (arc.angle + arc.size - 90) * ARC;
    ctx.save();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 12;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, arcStart, arcEnd);
    ctx.stroke();
    ctx.restore();
  }

  function drawSpot() {
    var a = (spot.angle - 90) * ARC;
    var ax = centerX + radius * Math.cos(a);
    var ay = centerY + radius * Math.sin(a);
    ctx.save();
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(ax, ay, spot.radius, 0, ARC4);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function easing(k) {
  	return 0.5 * (1 - Math.cos(Math.PI * k));
  }
  </script>
</body>

</html>
